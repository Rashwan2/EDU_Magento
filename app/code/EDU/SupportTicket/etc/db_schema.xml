<?xml version="1.0"?>
<schema xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="urn:magento:framework:Setup/Declaration/Schema/etc/schema.xsd">

    <!-- Support Ticket Categories Table -->
    <table name="support_ticket_category" resource="default" engine="innodb" comment="Support Ticket Categories">
        <column xsi:type="int" name="category_id" padding="10" unsigned="true" nullable="false" identity="true" comment="Category ID"/>
        <column xsi:type="varchar" name="name" length="255" nullable="false" comment="Category Name"/>
        <column xsi:type="varchar" name="slug" length="255" nullable="false" comment="Category Slug"/>
        <column xsi:type="text" name="description" nullable="true" comment="Category Description"/>
        <column xsi:type="tinyint" name="is_active" nullable="false" default="1" comment="Is Active"/>
        <column xsi:type="int" name="sort_order" padding="10" unsigned="true" nullable="false" default="0" comment="Sort Order"/>
        <column xsi:type="timestamp" name="created_at" on_update="false" nullable="false" default="CURRENT_TIMESTAMP" comment="Created At"/>
        <column xsi:type="timestamp" name="updated_at" on_update="true" nullable="false" default="CURRENT_TIMESTAMP" comment="Updated At"/>

        <constraint xsi:type="primary" referenceId="PRIMARY">
            <column name="category_id"/>
        </constraint>

        <index referenceId="SUPPORT_TICKET_CATEGORY_SLUG" indexType="btree">
            <column name="slug"/>
        </index>

        <index referenceId="SUPPORT_TICKET_CATEGORY_ACTIVE" indexType="btree">
            <column name="is_active"/>
        </index>
    </table>

    <!-- Support Ticket Priorities Table -->
    <table name="support_ticket_priority" resource="default" engine="innodb" comment="Support Ticket Priorities">
        <column xsi:type="int" name="priority_id" padding="10" unsigned="true" nullable="false" identity="true" comment="Priority ID"/>
        <column xsi:type="varchar" name="name" length="100" nullable="false" comment="Priority Name"/>
        <column xsi:type="varchar" name="color" length="7" nullable="false" default="#007bff" comment="Priority Color"/>
        <column xsi:type="int" name="sort_order" padding="10" unsigned="true" nullable="false" default="0" comment="Sort Order"/>
        <column xsi:type="tinyint" name="is_active" nullable="false" default="1" comment="Is Active"/>
        <column xsi:type="timestamp" name="created_at" on_update="false" nullable="false" default="CURRENT_TIMESTAMP" comment="Created At"/>

        <constraint xsi:type="primary" referenceId="PRIMARY">
            <column name="priority_id"/>
        </constraint>

        <index referenceId="SUPPORT_TICKET_PRIORITY_SORT" indexType="btree">
            <column name="sort_order"/>
        </index>
    </table>

    <!-- Support Tickets Table -->
    <table name="support_ticket" resource="default" engine="innodb" comment="Support Tickets">
        <column xsi:type="int" name="ticket_id" padding="10" unsigned="true" nullable="false" identity="true" comment="Ticket ID"/>
        <column xsi:type="varchar" name="ticket_number" length="50" nullable="false" comment="Ticket Number"/>
        <column xsi:type="int" name="customer_id" padding="10" unsigned="true" nullable="true" comment="Customer ID"/>
        <column xsi:type="varchar" name="customer_email" length="255" nullable="true" comment="Customer Email"/>
        <column xsi:type="varchar" name="customer_name" length="255" nullable="true" comment="Customer Name"/>
        <column xsi:type="varchar" name="subject" length="500" nullable="false" comment="Ticket Subject"/>
        <column xsi:type="text" name="description" nullable="false" comment="Ticket Description"/>
        <column xsi:type="varchar" name="status" length="20" nullable="false" default="open" comment="Ticket Status"/>
        <column xsi:type="int" name="priority_id" padding="10" unsigned="true" nullable="false" comment="Priority ID"/>
        <column xsi:type="int" name="category_id" padding="10" unsigned="true" nullable="false" comment="Category ID"/>
        <column xsi:type="int" name="assigned_to" padding="10" unsigned="true" nullable="true" comment="Assigned To Admin User"/>
        <column xsi:type="varchar" name="order_number" length="50" nullable="true" comment="Related Order Number"/>
        <column xsi:type="varchar" name="attachment" length="500" nullable="true" comment="Attachment File Path"/>
        <column xsi:type="timestamp" name="last_reply_at" nullable="true" comment="Last Reply At"/>
        <column xsi:type="timestamp" name="resolved_at" nullable="true" comment="Resolved At"/>
        <column xsi:type="timestamp" name="created_at" on_update="false" nullable="false" default="CURRENT_TIMESTAMP" comment="Created At"/>
        <column xsi:type="timestamp" name="updated_at" on_update="true" nullable="false" default="CURRENT_TIMESTAMP" comment="Updated At"/>

        <constraint xsi:type="primary" referenceId="PRIMARY">
            <column name="ticket_id"/>
        </constraint>

        <constraint xsi:type="foreign" referenceId="SUPPORT_TICKET_CUSTOMER_ID_CUSTOMER_ENTITY_ENTITY_ID"
                    table="support_ticket" column="customer_id"
                    referenceTable="customer_entity" referenceColumn="entity_id"
                    onDelete="SET NULL"/>

        <constraint xsi:type="foreign" referenceId="SUPPORT_TICKET_PRIORITY_ID_SUPPORT_TICKET_PRIORITY_PRIORITY_ID"
                    table="support_ticket" column="priority_id"
                    referenceTable="support_ticket_priority" referenceColumn="priority_id"
                    onDelete="CASCADE"/>

        <constraint xsi:type="foreign" referenceId="SUPPORT_TICKET_CATEGORY_ID_SUPPORT_TICKET_CATEGORY_CATEGORY_ID"
                    table="support_ticket" column="category_id"
                    referenceTable="support_ticket_category" referenceColumn="category_id"
                    onDelete="CASCADE"/>

        <constraint xsi:type="foreign" referenceId="SUPPORT_TICKET_ASSIGNED_TO_ADMIN_USER_USER_ID"
                    table="support_ticket" column="assigned_to"
                    referenceTable="admin_user" referenceColumn="user_id"
                    onDelete="SET NULL"/>

        <index referenceId="SUPPORT_TICKET_NUMBER" indexType="btree">
            <column name="ticket_number"/>
        </index>

        <index referenceId="SUPPORT_TICKET_CUSTOMER_ID" indexType="btree">
            <column name="customer_id"/>
        </index>

        <index referenceId="SUPPORT_TICKET_STATUS" indexType="btree">
            <column name="status"/>
        </index>

        <index referenceId="SUPPORT_TICKET_PRIORITY_ID" indexType="btree">
            <column name="priority_id"/>
        </index>

        <index referenceId="SUPPORT_TICKET_CATEGORY_ID" indexType="btree">
            <column name="category_id"/>
        </index>

        <index referenceId="SUPPORT_TICKET_ASSIGNED_TO" indexType="btree">
            <column name="assigned_to"/>
        </index>

        <index referenceId="SUPPORT_TICKET_CREATED_AT" indexType="btree">
            <column name="created_at"/>
        </index>
    </table>

    <!-- Support Ticket Messages Table -->
    <table name="support_ticket_message" resource="default" engine="innodb" comment="Support Ticket Messages">
        <column xsi:type="int" name="message_id" padding="10" unsigned="true" nullable="false" identity="true" comment="Message ID"/>
        <column xsi:type="int" name="ticket_id" padding="10" unsigned="true" nullable="false" comment="Ticket ID"/>
        <column xsi:type="int" name="sender_id" padding="10" unsigned="true" nullable="true" comment="Sender ID (Customer or Admin)"/>
        <column xsi:type="varchar" name="sender_type" length="20" nullable="false" comment="Sender Type (customer/admin)"/>
        <column xsi:type="varchar" name="sender_name" length="255" nullable="false" comment="Sender Name"/>
        <column xsi:type="varchar" name="sender_email" length="255" nullable="true" comment="Sender Email"/>
        <column xsi:type="text" name="message" nullable="false" comment="Message Content"/>
        <column xsi:type="tinyint" name="is_internal" nullable="false" default="0" comment="Is Internal Note"/>
        <column xsi:type="varchar" name="attachment" length="500" nullable="true" comment="Attachment File Path"/>
        <column xsi:type="timestamp" name="created_at" on_update="false" nullable="false" default="CURRENT_TIMESTAMP" comment="Created At"/>

        <constraint xsi:type="primary" referenceId="PRIMARY">
            <column name="message_id"/>
        </constraint>

        <constraint xsi:type="foreign" referenceId="SUPPORT_TICKET_MESSAGE_TICKET_ID_SUPPORT_TICKET_TICKET_ID"
                    table="support_ticket_message" column="ticket_id"
                    referenceTable="support_ticket" referenceColumn="ticket_id"
                    onDelete="CASCADE"/>

        <index referenceId="SUPPORT_TICKET_MESSAGE_TICKET_ID" indexType="btree">
            <column name="ticket_id"/>
        </index>

        <index referenceId="SUPPORT_TICKET_MESSAGE_SENDER" indexType="btree">
            <column name="sender_id"/>
            <column name="sender_type"/>
        </index>

        <index referenceId="SUPPORT_TICKET_MESSAGE_CREATED_AT" indexType="btree">
            <column name="created_at"/>
        </index>
    </table>

    <!-- Support Ticket Status History Table (Optional - for tracking status changes) -->
    <table name="support_ticket_status_history" resource="default" engine="innodb" comment="Support Ticket Status History">
        <column xsi:type="int" name="history_id" padding="10" unsigned="true" nullable="false" identity="true" comment="History ID"/>
        <column xsi:type="int" name="ticket_id" padding="10" unsigned="true" nullable="false" comment="Ticket ID"/>
        <column xsi:type="varchar" name="old_status" length="20" nullable="true" comment="Old Status"/>
        <column xsi:type="varchar" name="new_status" length="20" nullable="false" comment="New Status"/>
        <column xsi:type="int" name="changed_by" padding="10" unsigned="true" nullable="true" comment="Changed By Admin User"/>
        <column xsi:type="text" name="comment" nullable="true" comment="Status Change Comment"/>
        <column xsi:type="timestamp" name="created_at" on_update="false" nullable="false" default="CURRENT_TIMESTAMP" comment="Created At"/>

        <constraint xsi:type="primary" referenceId="PRIMARY">
            <column name="history_id"/>
        </constraint>

        <constraint xsi:type="foreign" referenceId="SUPPORT_TICKET_STATUS_HISTORY_TICKET_ID_SUPPORT_TICKET_TICKET_ID"
                    table="support_ticket_status_history" column="ticket_id"
                    referenceTable="support_ticket" referenceColumn="ticket_id"
                    onDelete="CASCADE"/>

        <constraint xsi:type="foreign" referenceId="SUPPORT_TICKET_STATUS_HISTORY_CHANGED_BY_ADMIN_USER_USER_ID"
                    table="support_ticket_status_history" column="changed_by"
                    referenceTable="admin_user" referenceColumn="user_id"
                    onDelete="SET NULL"/>

        <index referenceId="SUPPORT_TICKET_STATUS_HISTORY_TICKET_ID" indexType="btree">
            <column name="ticket_id"/>
        </index>

        <index referenceId="SUPPORT_TICKET_STATUS_HISTORY_CREATED_AT" indexType="btree">
            <column name="created_at"/>
        </index>
    </table>
</schema>

